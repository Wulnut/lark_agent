# 工作项过滤方法汇总

## 当前问题

我们已经可以通过 `/work_item/filter` 接口获取工作项列表，但需要实现更复杂的条件过滤功能，如：
- 按优先级、状态、负责人等字段筛选
- 多条件组合查询（AND/OR）
- 查询工作项的关联项

## 5 种过滤方法对比

| 方法 | API 路径 | 适用场景 | 脚本文件 |
|------|---------|---------|---------|
| **1. 单空间基础过滤** | `POST /open_api/{project_key}/work_item/filter` | 按类型、状态简单筛选 | `filter_single_project.py` |
| **2. 跨空间过滤** | `POST /open_api/work_items/filter_across_project` | 多项目联合查询 | `filter_across_project.py` |
| **3. 单空间复杂传参** | `POST /open_api/{project_key}/work_item/{type_key}/search/params` | 字段级复杂条件组合 | `search_params.py` |
| **4. 全局搜索** | `POST /open_api/compositive_search` | 关键词全文检索 | `compositive_search.py` |
| **5. 关联工作项查询** | `POST /open_api/{project_key}/work_item/{type_key}/{id}/search_by_relation` | 获取指定工作项的关联项 | `search_by_relation.py` |

## 详细说明

### 1. 单空间基础过滤 (`filter`)

**接口**: `POST /open_api/{project_key}/work_item/filter`

**请求示例**:
```json
{
    "work_item_type_keys": ["670f3cdaddd89a6fa8f18e65"],
    "page_num": 1,
    "page_size": 50,
    "work_item_name": "关键词",
    "work_item_status": [],
    "created_at": {"start": 1700000000000, "end": 1800000000000},
    "expand": {"need_user_detail": true}
}
```

**支持的过滤参数**:
- `work_item_type_keys`: 工作项类型 key 列表
- `work_item_name`: 按名称模糊匹配
- `work_item_status`: 状态列表
- `created_at`: 创建时间范围

**特点**: 简单快速，适合基础场景

**参考文档**: https://project.feishu.cn/b/helpcenter/1p8d7djs/1attl6vt

---

### 2. 跨空间过滤 (`filter_across_project`)

**接口**: `POST /open_api/work_items/filter_across_project`

**请求示例**:
```json
{
    "project_keys": ["proj_key_1", "proj_key_2"],
    "work_item_type_key": "story",
    "page_num": 1,
    "page_size": 10
}
```

**特点**: 跨多个项目空间统一查询

**参考文档**: https://project.feishu.cn/b/helpcenter/1p8d7djs/1hpwuxld

---

### 3. 单空间复杂传参 (`search/params`) - 推荐

**接口**: `POST /open_api/{project_key}/work_item/{type_key}/search/params`

**请求示例**:
```json
{
    "search_group": {
        "conjunction": "AND",
        "search_params": [
            {
                "field_key": "priority",
                "operator": "IN",
                "value": ["option_3"]
            },
            {
                "field_key": "created_by",
                "operator": "IN",
                "value": ["user_id"]
            }
        ],
        "search_groups": []
    },
    "fields": ["name", "priority", "status"],
    "page_num": 1,
    "page_size": 20
}
```

**支持的操作符**:
| 操作符 | 说明 | 示例 |
|-------|------|-----|
| `IN` | 包含于 | `["value1", "value2"]` |
| `NOT_IN` | 不包含于 | `["value1"]` |
| `EQ` | 等于 | `"value"` |
| `NE` | 不等于 | `"value"` |
| `GT` | 大于 | `1000` |
| `LT` | 小于 | `2000` |
| `GE` | 大于等于 | `1000` |
| `LE` | 小于等于 | `2000` |
| `LIKE` | 模糊匹配 | `"关键词"` |
| `IS_NULL` | 为空 | `null` |
| `IS_NOT_NULL` | 不为空 | `null` |

**嵌套条件示例**:
```json
{
    "search_group": {
        "conjunction": "AND",
        "search_params": [
            {"field_key": "priority", "operator": "IN", "value": ["option_3"]}
        ],
        "search_groups": [
            {
                "conjunction": "OR",
                "search_params": [
                    {"field_key": "owner", "operator": "IN", "value": ["user_1"]},
                    {"field_key": "owner", "operator": "IN", "value": ["user_2"]}
                ]
            }
        ]
    }
}
```

**特点**: 
- 支持 AND/OR 嵌套逻辑
- 多字段组合
- 操作符丰富
- 可指定返回字段

**参考文档**: https://project.feishu.cn/b/helpcenter/1p8d7djs/19pti4e2

---

### 4. 全局搜索 (`compositive_search`)

**接口**: `POST /open_api/compositive_search`

**请求示例**:
```json
{
    "project_keys": ["project_key"],
    "query": "搜索关键词",
    "query_type": "story",
    "page_num": 1,
    "page_size": 10
}
```

**特点**: 全文检索，类似搜索引擎

**参考文档**: https://project.feishu.cn/b/helpcenter/1p8d7djs/42w754bv

---

### 5. 关联工作项查询 (`search_by_relation`)

**接口**: `POST /open_api/{project_key}/work_item/{type_key}/{work_item_id}/search_by_relation`

**请求示例**:
```json
{
    "relation_work_item_type_key": "issue",
    "page_num": 1,
    "page_size": 10,
    "expand": {"need_workflow": true, "need_user_detail": true}
}
```

**特点**: 查询指定工作项的关联项（如需求关联的 Bug）

**参考文档**: https://project.feishu.cn/b/helpcenter/1p8d7djs/39dcbh1d

---

## 推荐使用场景

| 需求 | 推荐方法 |
|-----|---------|
| 获取某类型所有工作项 | 方法 1 (`filter`) |
| 按优先级/状态/负责人复杂筛选 | 方法 3 (`search/params`) |
| 查询工作项的关联项 | 方法 5 (`search_by_relation`) |
| 跨多个项目查询 | 方法 2 (`filter_across_project`) |
| 关键词模糊搜索 | 方法 4 (`compositive_search`) |

---

## 相关脚本位置

所有测试脚本位于 `scripts/work_items/get_work_items_list/` 目录：

```
scripts/work_items/get_work_items_list/
├── filter_single_project.py      # 方法1: 单空间基础过滤
├── filter_across_project.py      # 方法2: 跨空间过滤
├── search_params.py              # 方法3: 复杂传参搜索
├── compositive_search.py         # 方法4: 全局搜索
├── search_by_relation.py         # 方法5: 关联工作项查询
└── get_issue_list.py             # Issue管理专用查询
```

## 关联字段过滤的特殊处理

### 问题

`work_item_related_multi_select` 类型的字段（如"关联项目"）**不支持** `search/params` 搜索，会返回错误：

```json
{"err_code": 20068, "err_msg": "Search Param Is Not Support"}
```

### 解决方案：客户端过滤

由于 API 限制，需要采用客户端过滤方案：

1. **获取关联项目映射**: 先获取"项目管理"类型的工作项列表，建立 ID -> 名称 映射
2. **获取全部 Issue**: 调用 `filter` 接口获取所有 Issue
3. **客户端过滤**: 遍历 Issue 的 `field_3bf6c0`（关联项目字段），按目标项目 ID 过滤

### 关键字段信息

| 字段 | 值 |
|------|-----|
| Issue管理 type_key | `670f3cdaddd89a6fa8f18e65` |
| 项目管理 type_key | `66baf93dbbde858d97564e56` |
| 关联项目 field_key | `field_3bf6c0` |
| 关联项目 field_type | `work_item_related_multi_select` |

### 使用示例

```bash
# 按项目名称模糊匹配
uv run scripts/work_items/get_work_items_list/filter_issues_by_project.py --project-name "AI耳机"

# 按项目 ID 精确匹配
uv run scripts/work_items/get_work_items_list/filter_issues_by_project.py --project-id 6645173426

# 列出所有可用的关联项目
uv run scripts/work_items/get_work_items_list/filter_issues_by_project.py --list-projects

# 显示使用统计
uv run scripts/work_items/get_work_items_list/filter_issues_by_project.py
```

---

## 下一步计划

1. 基于 `search/params` 接口实现通用的条件过滤 Provider（支持优先级、状态等普通字段）
2. 封装关联字段过滤为 Provider 方法（客户端过滤方案）
3. 将过滤能力集成到 MCP Tool 中
4. 考虑缓存关联项目映射以提升性能
