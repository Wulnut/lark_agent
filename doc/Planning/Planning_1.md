# 飞书 Agent 项目规划

## 近期优化计划 (Immediate Next Steps)

基于 Stage 1 已完成的工作，以下优化建议可进一步提升项目质量和用户体验：

### 1.1 工具描述增强
**目标**: 帮助 AI 代理更好地理解 MCP 工具的用途和参数
**任务**:
- [ ] 为每个 MCP 工具添加更详细的使用示例
- [ ] 完善参数的业务含义描述
- [ ] 添加工具间的依赖关系说明
**优先级**: 高

### 1.2 集成测试完善
**目标**: 确保可读性字段转换在各种场景下正常工作
**任务**:
- [ ] 添加 `get_readable_issue_details` 的集成测试
- [ ] 测试各种字段格式（用户列表、选项字典、复杂对象）
- [ ] 验证边缘情况（空字段、异常数据格式）
**优先级**: 高

### 1.3 字段类型扩展
**目标**: 支持更多字段类型的智能可读性转换
**任务**:
- [ ] 日期时间字段的本地化格式化
- [ ] 枚举值的业务含义映射
- [ ] 复杂对象字段的摘要提取
**优先级**: 中

### 1.4 性能优化
**目标**: 提升关联查询等场景的性能
**任务**:
- [ ] 优化 `related_to` 参数的客户端过滤算法
- [ ] 添加查询结果缓存机制
- [ ] 实现增量数据加载
**优先级**: 中

### 1.5 文档完善
**目标**: 提供完整的项目文档体系
**任务**:
- [ ] 创建外部 API 使用指南
- [ ] 编写故障排查手册
- [ ] 制作快速上手教程
**优先级**: 低

---

# Stage 2: Workflow 编排实施计划

## 1. 背景与目标

### 1.1 当前状态
- ✅ **Stage 1 已完成**: 飞书项目 MCP 工具集已完备
  - 6个核心工具: `list_projects`, `create_task`, `get_tasks`, `get_task_detail`, `update_task`, `get_task_options`
  - 全异步架构，支持动态元数据发现
  - 数据可读性增强（用户字段自动转换为人名）
  - 健壮的错误处理和重试机制
  - 201个测试用例全部通过

### 1.2 Stage 2 目标
将单点工具升级为**可编排的工作流**，支持复杂、多步骤的业务场景。

**核心能力**:
1. **状态管理**: 跟踪复杂任务的执行进度
2. **条件分支**: 根据执行结果决定下一步操作
3. **并行执行**: 同时处理多个相关任务
4. **错误恢复**: 优雅处理失败并重试/补偿
5. **可视化**: 提供工作流执行状态的可视化界面

## 2. 技术选型评估

### 2.1 LangGraph 分析

**优势**:
- 原生支持 StateGraph 概念，天然适合工作流编排
- 与 LangChain 生态深度集成，方便未来 Agent 化演进
- 提供可视化调试工具
- 支持并行执行和条件分支

**挑战**:
- 学习曲线相对较陡
- 需要重新设计状态管理模型

### 2.2 备选方案

1. **直接使用 asyncio + 状态机**:
   - 优点: 轻量级，无外部依赖
   - 缺点: 需要手动实现所有编排逻辑，维护成本高

2. **使用 taskflow 或类似库**:
   - 优点: 专门为任务编排设计
   - 缺点: 社区生态不如 LangGraph 活跃

**推荐方案**: **LangGraph**
- 与项目长期演进路线（Stage 3 Agent 化）高度契合
- 提供丰富的工具和调试能力
- 可复用现有的 MCP 工具作为节点

## 3. 架构设计

### 3.1 核心组件

```
src/workflow/
├── graphs/              # 预定义工作流图
│   ├── requirements_to_tasks.py    # 需求拆解工作流
│   ├── weekly_report.py            # 周报生成工作流
│   └── bug_triage.py              # Bug 分诊工作流
├── nodes/              # 可复用节点
│   ├── feishu/        # 飞书相关节点
│   │   ├── create_task.py
│   │   ├── filter_tasks.py
│   │   └── get_task_detail.py
│   └── llm/           # LLM 相关节点
│       ├── analyze_requirement.py
│       ├── generate_report.py
│       └── prioritize_tasks.py
├── state/              # 状态模型定义
│   ├── base.py        # 基础状态类
│   └── requirements.py # 需求拆解状态
└── orchestrator.py     # 工作流编排器
```

### 3.2 状态模型设计

```python
class WorkflowState(TypedDict):
    """工作流基础状态"""
    # 输入参数
    input: dict
    # 中间结果
    intermediate_results: dict
    # 错误信息
    errors: List[str]
    # 当前步骤
    current_step: str
    # 是否完成
    is_completed: bool
    # 最终输出
    output: Optional[dict]
```

### 3.3 工作流执行流程

```
用户请求
    ↓
解析工作流类型
    ↓
初始化状态机
    ↓
执行节点（支持重试）
    ↓
状态检查 → 失败 → 错误处理
    ↓
条件分支判断
    ↓
选择下一节点
    ↓
循环执行直至完成
    ↓
返回结果
```

## 4. 实施计划（分阶段）

### 阶段 1: 基础框架搭建 (2-3周)

#### 4.1.1 技术调研与原型 (Week 1)
- [ ] **调研**: 深入学习 LangGraph 核心概念（StateGraph, Nodes, Edges）
- [ ] **原型**: 创建简单的 "Hello World" 工作流
- [ ] **集成测试**: 验证 LangGraph 与现有代码的兼容性

#### 4.1.2 状态管理框架 (Week 2)
- [ ] **设计**: 定义通用的 `WorkflowState` 模型
- [ ] **实现**: 创建状态持久化层（内存 + 可选数据库）
- [ ] **测试**: 编写状态管理的单元测试

#### 4.1.3 节点封装 (Week 3)
- [ ] **封装**: 将现有的 MCP 工具包装为 LangGraph 节点
- [ ] **标准化**: 定义节点输入输出接口规范
- [ ] **错误处理**: 实现节点的错误处理和重试逻辑

### 阶段 2: 首个工作流实现 (2-3周)

#### 4.2.1 "需求拆解" 工作流 (Week 4-5)
- **业务场景**: 用户描述一个复杂需求 → 拆解为多个子任务 → 批量创建
- **节点设计**:
  1. `analyze_requirement`: LLM 分析需求，拆解为子任务
  2. `validate_tasks`: 验证子任务合理性
  3. `batch_create_tasks`: 批量创建飞书任务
  4. `link_tasks`: 建立任务间的依赖关系
- **状态流转**:
  ```
  需求分析 → 任务验证 → 批量创建 → 建立关联 → 完成
        ↓          ↓          ↓
     错误处理 → 错误处理 → 错误处理
  ```

#### 4.2.2 测试与优化 (Week 6)
- [ ] **集成测试**: 完整的工作流端到端测试
- [ ] **性能测试**: 评估工作流执行效率
- [ ] **错误恢复**: 测试各种失败场景的恢复能力

### 阶段 3: 扩展与增强 (2-3周)

#### 4.3.1 更多工作流模式 (Week 7-8)
- [ ] **周报生成**: 自动收集项目进展，生成结构化报告
- [ ] **Bug 分诊**: 根据 Bug 描述自动分配负责人和优先级
- [ ] **进度同步**: 跨项目同步任务状态

#### 4.3.2 可视化与监控 (Week 9)
- [ ] **执行监控**: 实时查看工作流执行状态
- [ ] **历史记录**: 保存工作流执行历史
- [ ] **性能指标**: 收集工作流执行指标（成功率、耗时等）

## 5. 技术风险与缓解措施

### 5.1 主要风险

1. **LangGraph 学习曲线**
   - **风险**: 团队成员需要时间掌握新框架
   - **缓解**: 提前进行技术培训，制作内部学习资料

2. **状态管理复杂性**
   - **风险**: 状态模型设计不当导致难以扩展
   - **缓解**: 采用渐进式设计，先实现简单场景，再逐步复杂化

3. **性能问题**
   - **风险**: 工作流执行效率低于预期
   - **缓解**: 早期进行性能测试，优化瓶颈节点

### 5.2 成功标准

1. **功能标准**:
   - 至少实现 3 个可用的工作流
   - 工作流执行成功率 > 95%
   - 平均执行时间 < 30秒（简单工作流）

2. **质量标准**:
   - 工作流模块测试覆盖率 > 80%
   - 支持完整的错误处理和重试机制
   - 提供工作流状态监控界面

3. **用户体验**:
   - 工作流配置简单直观
   - 执行状态清晰可查
   - 错误信息易于理解

## 6. 与 Stage 3 的衔接

Workflow 编排是 Agent 自主进化的**必要前置条件**:

1. **技能积累**: 工作流节点将成为 Agent 的基础技能
2. **状态管理**: 工作流状态机为 Agent 的规划能力提供框架
3. **错误处理**: 工作流的错误恢复机制可被 Agent 复用

**演进路径**:
```
单点工具 (Stage 1)
    ↓
可编排工作流 (Stage 2)
    ↓
自主规划 Agent (Stage 3)
```

## 7. 下一步行动

**立即开始**:
1. 成立 Stage 2 专项小组
2. 安排 LangGraph 技术培训（1-2天）
3. 搭建开发环境，安装 LangGraph 依赖

**短期目标** (1个月内):
1. 完成基础框架搭建
2. 实现首个工作流原型
3. 进行内部演示和反馈收集

**中期目标** (2-3个月):
1. 完善工作流生态
2. 建立监控和运维体系
3. 为 Stage 3 打好基础