# Lark Agent 安装使用指南

## 📦 安装方式

### 方式一：通过 uv tool install（推荐）

这是最简单的方式，适合直接使用：

```bash
uv tool install --from git+https://github.com/Wulnut/lark_agent lark-agent
```

安装后，可以直接使用 `lark-agent` 命令：

```bash
lark-agent
```

#### 更新版本

如果需要更新到新版本，使用 `--force` 参数重新安装：

```bash
# 更新到最新版本（main 分支）
uv tool install --from git+https://github.com/Wulnut/lark_agent lark-agent --force

# 更新到特定版本/tag（例如 v0.0.2）
uv tool install --from git+https://github.com/Wulnut/lark_agent@v0.0.2 lark-agent --force

# 查看已安装的工具列表
uv tool list
```

### 方式二：从源码安装

```bash
# 克隆仓库
git clone https://github.com/Wulnut/lark_agent.git
cd lark_agent

# 安装依赖
uv sync

# 运行
uv run main.py
```

### 方式三：Docker 部署

```bash
# 构建镜像
docker build -t lark-agent .

# 运行（需要提供 .env 文件）
docker run --env-file .env lark-agent
```

---

## ⚙️ 配置

### 1. 环境变量配置

创建 `.env` 文件（如果使用方式二或三），或在系统环境变量中设置：

```bash
# 飞书应用凭证（可选，仅在使用 IM 功能时需要）
LARK_APP_ID=your_app_id
LARK_APP_SECRET=your_app_secret

# 飞书项目 API 凭证（二选一，至少需要配置一种）
# 方式 A: 使用 Token 和 User Key
FEISHU_PROJECT_USER_TOKEN=your_token
FEISHU_PROJECT_USER_KEY=your_user_key

# 方式 B: 使用 Plugin ID 和 Secret（推荐）
FEISHU_PROJECT_PLUGIN_ID=your_plugin_id
FEISHU_PROJECT_PLUGIN_SECRET=your_plugin_secret

# 可选配置
FEISHU_PROJECT_BASE_URL=https://project.feishu.cn  # 私有化部署地址
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

### 2. MCP 客户端配置

#### Cursor IDE 配置

编辑 `~/.cursor/mcp.json`（Linux/macOS）或 `%APPDATA%\Cursor\mcp.json`（Windows）：

**如果使用 `uv tool install` 安装：**
```json
{
  "mcpServers": {
    "lark-agent": {
      "command": "lark-agent"
    }
  }
}
```

**注意**：确保已配置必需的环境变量（`FEISHU_PROJECT_PLUGIN_ID` 和 `FEISHU_PROJECT_PLUGIN_SECRET`，或 `FEISHU_PROJECT_USER_TOKEN` 和 `FEISHU_PROJECT_USER_KEY`），否则启动会失败。

**如果从源码运行：**
```json
{
  "mcpServers": {
    "lark-agent": {
      "command": "uv",
      "args": [
        "run",
        "--directory",
        "/path/to/lark_agent",
        "main.py"
      ]
    }
  }
}
```

#### Claude Desktop 配置

编辑 `~/Library/Application Support/Claude/claude_desktop_config.json`（macOS）或 `%APPDATA%\Claude\claude_desktop_config.json`（Windows）：

```json
{
  "mcpServers": {
    "lark-agent": {
      "command": "lark-agent"
    }
  }
}
```

**注意**：确保已配置必需的环境变量（`FEISHU_PROJECT_PLUGIN_ID` 和 `FEISHU_PROJECT_PLUGIN_SECRET`，或 `FEISHU_PROJECT_USER_TOKEN` 和 `FEISHU_PROJECT_USER_KEY`），否则启动会失败。

---

## 🚀 使用示例

配置完成后，在 Cursor 或 Claude Desktop 中可以直接通过自然语言调用：

- "列出所有项目空间"
- "在 Project Management 项目中创建一个 P0 优先级的任务：修复登录问题"
- "查询 SR6D2VA-7552-Lark 项目的所有任务"
- "查找所有 SG06VA 相关的任务"
- "把任务 12345 的状态改为已完成"
- "查看状态字段有哪些可选值"

---

## 📝 注意事项

1. **环境变量优先级**：
   - 如果同时设置了 `FEISHU_PROJECT_USER_TOKEN` 和 `FEISHU_PROJECT_PLUGIN_ID`，优先使用 Token
   - 推荐使用 Plugin ID/Secret 方式，支持自动刷新 Token

2. **日志输出**：
   - 如果存在 `log/` 目录，日志会写入 `log/agent.log`
   - 否则日志会输出到 stderr

3. **配置修改后**：
   - 需要重启 Cursor 或 Claude Desktop 才能生效

4. **版本更新**：
   ```bash
   # 更新到最新版本（main 分支）
   uv tool install --from git+https://github.com/Wulnut/lark_agent lark-agent --force

   # 更新到特定版本/tag（例如 v0.0.2）
   uv tool install --from git+https://github.com/Wulnut/lark_agent@v0.0.2 lark-agent --force

   # 查看当前安装的版本
   uv tool list | grep lark-agent
   ```

---

## 🔧 故障排查

### 问题：找不到 lark-agent 命令

**解决方案**：
- 确保 `uv` 已正确安装
- 检查 `~/.local/bin` 是否在 PATH 中（Linux/macOS）
- 检查 `%USERPROFILE%\.local\bin` 是否在 PATH 中（Windows）
- 验证安装：运行 `uv tool list` 查看已安装的工具

### 问题：认证失败

**解决方案**：
- 检查环境变量是否正确设置（至少需要配置 `FEISHU_PROJECT_PLUGIN_ID` 和 `FEISHU_PROJECT_PLUGIN_SECRET`，或 `FEISHU_PROJECT_USER_TOKEN` 和 `FEISHU_PROJECT_USER_KEY`）
- 确认飞书应用权限已正确配置
- 查看日志文件获取详细错误信息

### 问题：使用 IM 功能时提示缺少 LARK_APP_ID 或 LARK_APP_SECRET

**解决方案**：
- `LARK_APP_ID` 和 `LARK_APP_SECRET` 是可选的，仅在需要使用 IM（即时消息）功能时才需要配置
- 如果只需要使用项目（Project）功能，可以不配置这两个字段
- 如果需要使用 IM 功能，请按照上面的环境变量配置方法设置这两个字段

### 问题：MCP 连接失败

**解决方案**：
- 确认配置文件路径正确
- 检查命令路径是否正确
- 查看 Cursor/Claude Desktop 的日志输出
